name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  JAVA_VERSION: 17

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Create deployment package
        working-directory: ./backend
        run: |
          mkdir -p deploy-package
          cp target/finance-backend-*.jar deploy-package/finance-backend.jar
          cp scripts/deploy.sh deploy-package/
          cp scripts/finance-app.service deploy-package/
          tar -czf deploy-package.tar.gz -C deploy-package .

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          scp -i ~/.ssh/deploy_key \
              backend/deploy-package.tar.gz \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' << 'EOF'
            set -e
            DEPLOY_DIR="/opt/finance-app"
            BACKUP_DIR="/opt/finance-app/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Create directories if they don't exist
            sudo mkdir -p $DEPLOY_DIR
            sudo mkdir -p $BACKUP_DIR
            
            # Extract deployment package
            cd /tmp
            tar -xzf deploy-package.tar.gz
            
            # Backup existing JAR if it exists
            if [ -f "$DEPLOY_DIR/finance-backend.jar" ]; then
              sudo cp $DEPLOY_DIR/finance-backend.jar $BACKUP_DIR/finance-backend-$TIMESTAMP.jar
            fi
            
            # Stop the service
            sudo systemctl stop finance-app || true
            
            # Copy new JAR
            sudo cp finance-backend.jar $DEPLOY_DIR/
            sudo chown ec2-user:ec2-user $DEPLOY_DIR/finance-backend.jar
            
            # Copy and setup systemd service if it doesn't exist
            if [ ! -f /etc/systemd/system/finance-app.service ]; then
              sudo cp finance-app.service /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable finance-app
            fi
            
            # Start the service
            sudo systemctl start finance-app
            
            # Wait a bit and check status
            sleep 5
            sudo systemctl status finance-app --no-pager || true
            
            # Cleanup
            rm -rf /tmp/deploy-package.tar.gz /tmp/deploy-package
            
            echo "Deployment completed successfully!"
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'sudo systemctl is-active finance-app && echo "Service is running" || exit 1'

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf backend/deploy-package backend/deploy-package.tar.gz

