name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  JAVA_VERSION: 17

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Create deployment package
        working-directory: ./backend
        run: |
          mkdir -p deploy-package
          cp target/finance-backend-*.jar deploy-package/finance-backend.jar
          cp scripts/deploy.sh deploy-package/
          cp scripts/finance-app.service deploy-package/
          tar -czf deploy-package.tar.gz -C deploy-package .

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write private key, handling potential formatting issues
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Remove any trailing whitespace/newlines
          sed -i '' 's/[[:space:]]*$//' ~/.ssh/deploy_key 2>/dev/null || sed -i 's/[[:space:]]*$//' ~/.ssh/deploy_key
          # Add EC2 host to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1 || true
          chmod 644 ~/.ssh/known_hosts
          
          # Debug: Verify key format (without exposing the key)
          echo "Checking SSH key format..."
          head -n 1 ~/.ssh/deploy_key | grep -q "BEGIN" && echo "✓ Key header found" || echo "⚠ Key header missing"
          tail -n 1 ~/.ssh/deploy_key | grep -q "END" && echo "✓ Key footer found" || echo "⚠ Key footer missing"
          
      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to EC2..."
          echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "EC2_USER: ${{ secrets.EC2_USER }}"
          
          # Test network connectivity first
          echo "Testing network connectivity..."
          if ping -c 3 ${{ secrets.EC2_HOST }} 2>&1 | grep -q "0 received"; then
            echo "⚠️  Warning: Cannot ping EC2 host. Instance might be stopped or unreachable."
          else
            echo "✓ Network connectivity OK"
          fi
          
          # Test SSH connection
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o ServerAliveInterval=5 \
              -o ServerAliveCountMax=3 \
              -v \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'echo "SSH connection successful!"' || {
            echo ""
            echo "❌ SSH connection failed!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify EC2_HOST is correct: ${{ secrets.EC2_HOST }}"
            echo "2. Verify EC2_USER is correct: ${{ secrets.EC2_USER }} (should be 'ubuntu' for Ubuntu instances)"
            echo "3. Check EC2 instance status in AWS Console - ensure it's running"
            echo "4. Verify EC2 security group allows SSH (port 22) from GitHub Actions IPs"
            echo "   - GitHub Actions uses dynamic IPs, consider allowing SSH from 0.0.0.0/0 temporarily for testing"
            echo "   - Or use AWS Systems Manager Session Manager as an alternative"
            echo "5. Verify private key matches the public key on EC2 instance"
            echo "6. Check EC2 instance logs in AWS Console for any errors"
            echo ""
            echo "Security Group Configuration:"
            echo "  - Inbound Rule: SSH (22) from GitHub Actions IPs or 0.0.0.0/0"
            echo "  - Outbound Rule: All traffic (for SSH responses)"
            exit 1
          }

      - name: Deploy to EC2
        run: |
          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              backend/deploy-package.tar.gz \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' << 'EOF'
            set -e
            DEPLOY_DIR="/opt/finance-app"
            BACKUP_DIR="/opt/finance-app/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Create directories if they don't exist
            sudo mkdir -p $DEPLOY_DIR
            sudo mkdir -p $BACKUP_DIR
            
            # Extract deployment package to user-owned directory to avoid permission issues
            EXTRACT_DIR="/tmp/deploy-$(date +%s)"
            mkdir -p $EXTRACT_DIR
            cd $EXTRACT_DIR
            tar -xzf /tmp/deploy-package.tar.gz --no-same-owner --no-same-permissions 2>&1 | grep -v "Cannot utime\|Cannot change mode" || {
              # Extract ignoring permission errors (non-critical warnings)
              tar -xzf /tmp/deploy-package.tar.gz 2>&1 | grep -v "Cannot utime\|Cannot change mode" || true
            }
            
            # Backup existing JAR if it exists
            if [ -f "$DEPLOY_DIR/finance-backend.jar" ]; then
              sudo cp $DEPLOY_DIR/finance-backend.jar $BACKUP_DIR/finance-backend-$TIMESTAMP.jar
            fi
            
            # Stop the service
            sudo systemctl stop finance-app || true
            
            # Copy new JAR
            sudo cp $EXTRACT_DIR/finance-backend.jar $DEPLOY_DIR/
            sudo chown ubuntu:ubuntu $DEPLOY_DIR/finance-backend.jar
            
            # Copy and setup systemd service if it doesn't exist
            if [ ! -f /etc/systemd/system/finance-app.service ]; then
              sudo cp $EXTRACT_DIR/finance-app.service /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable finance-app
            fi
            
            # Verify prerequisites before starting
            echo "Verifying prerequisites..."
            if ! command -v java &> /dev/null; then
              echo "❌ Java is not installed!"
              echo "Installing Java 17..."
              sudo apt-get update -qq
              sudo apt-get install -y openjdk-17-jdk || sudo apt-get install -y default-jdk
            fi
            java -version || { echo "❌ Java installation failed"; exit 1; }
            
            # Verify JAR file exists and is readable
            if [ ! -f "$DEPLOY_DIR/finance-backend.jar" ]; then
              echo "❌ JAR file not found at $DEPLOY_DIR/finance-backend.jar"
              exit 1
            fi
            ls -lh $DEPLOY_DIR/finance-backend.jar
            
            # Check if port 8080 is already in use
            if sudo netstat -tlnp | grep -q ":8080 "; then
              echo "⚠️  Warning: Port 8080 is already in use"
              sudo netstat -tlnp | grep ":8080 "
            fi
            
            # Reload systemd daemon to pick up any service file changes
            sudo systemctl daemon-reload
            
            # Start the service
            echo "Starting finance-app service..."
            sudo systemctl start finance-app
            
            # Wait for service to start
            sleep 3
            
            # Check service status with detailed output
            echo "Checking service status..."
            sudo systemctl status finance-app --no-pager -l || true
            
            # Wait a bit more and check again
            sleep 5
            
            # Verify service is active
            if sudo systemctl is-active --quiet finance-app; then
              echo "✓ Service is running successfully!"
            else
              echo "❌ Service failed to start!"
              echo ""
              echo "Service status:"
              sudo systemctl status finance-app --no-pager -l || true
              echo ""
              echo "Recent service logs:"
              sudo journalctl -u finance-app -n 50 --no-pager || true
              echo ""
              echo "Checking for common issues:"
              echo "1. Java path:"
              which java || echo "  Java not found in PATH"
              echo "2. JAR file:"
              ls -lh $DEPLOY_DIR/finance-backend.jar || echo "  JAR file not found"
              echo "3. Environment file:"
              ls -lh /opt/finance-app/.env 2>/dev/null || echo "  .env file not found (optional)"
              echo "4. Port 8080:"
              sudo netstat -tlnp | grep ":8080 " || echo "  Port 8080 not in use"
              exit 1
            fi
            
            # Cleanup
            rm -rf /tmp/deploy-package.tar.gz $EXTRACT_DIR
            
            echo "Deployment completed successfully!"
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' << 'VERIFY_EOF'
            echo "=== Service Status ==="
            sudo systemctl status finance-app --no-pager -l || true
            echo ""
            echo "=== Recent Logs ==="
            sudo journalctl -u finance-app -n 30 --no-pager || true
            echo ""
            echo "=== Port Check ==="
            sudo netstat -tlnp | grep ":8080 " || echo "Port 8080 not in use"
            echo ""
            if sudo systemctl is-active --quiet finance-app; then
              echo "✓ Service is running successfully!"
              exit 0
            else
              echo "❌ Service is not running!"
              exit 1
            fi
          VERIFY_EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf backend/deploy-package backend/deploy-package.tar.gz

