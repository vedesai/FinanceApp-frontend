name: Deploy Frontend to AWS EC2
# Updated for FinanceApp-frontend repository (root-level structure)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Run linter
        env:
          CI: true
        run: npm run lint

      - name: Build React app
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || '/api' }}
          NODE_ENV: production
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r build/* deploy-package/
          cp .github/workflows/nginx-frontend.conf deploy-package/nginx-frontend.conf 2>/dev/null || echo "# Nginx config will be created on EC2" > deploy-package/nginx-frontend.conf
          tar -czf deploy-package.tar.gz -C deploy-package .

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write private key, handling potential formatting issues
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Remove any trailing whitespace/newlines
          sed -i '' 's/[[:space:]]*$//' ~/.ssh/deploy_key 2>/dev/null || sed -i 's/[[:space:]]*$//' ~/.ssh/deploy_key
          # Add EC2 host to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1 || true
          chmod 644 ~/.ssh/known_hosts
          
          # Debug: Verify key format (without exposing the key)
          echo "Checking SSH key format..."
          head -n 1 ~/.ssh/deploy_key | grep -q "BEGIN" && echo "✓ Key header found" || echo "⚠ Key header missing"
          tail -n 1 ~/.ssh/deploy_key | grep -q "END" && echo "✓ Key footer found" || echo "⚠ Key footer missing"
          
      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to EC2..."
          echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "EC2_USER: ${{ secrets.EC2_USER }}"
          
          # Test network connectivity first
          echo "Testing network connectivity..."
          if ping -c 3 ${{ secrets.EC2_HOST }} 2>&1 | grep -q "0 received"; then
            echo "⚠️  Warning: Cannot ping EC2 host. Instance might be stopped or unreachable."
          else
            echo "✓ Network connectivity OK"
          fi
          
          # Test SSH connection
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o ServerAliveInterval=5 \
              -o ServerAliveCountMax=3 \
              -v \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'echo "SSH connection successful!"' || {
            echo ""
            echo "❌ SSH connection failed!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify EC2_HOST is correct: ${{ secrets.EC2_HOST }}"
            echo "2. Verify EC2_USER is correct: ${{ secrets.EC2_USER }}"
            echo "3. Check EC2 instance status in AWS Console - ensure it's running"
            echo "4. Verify EC2 security group allows SSH (port 22) from GitHub Actions IPs"
            exit 1
          }

      - name: Setup Nginx on EC2
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' << 'SETUP_EOF'
            set -e
            echo "Setting up Nginx for frontend deployment..."
            
            # Check if nginx is installed
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo apt-get update -qq
              sudo apt-get install -y nginx
              sudo systemctl enable nginx
            else
              echo "✓ Nginx is already installed"
              nginx -v
            fi
            
            # Create deployment directory
            FRONTEND_DIR="/var/www/finance-frontend"
            sudo mkdir -p $FRONTEND_DIR
            sudo chown -R $USER:$USER $FRONTEND_DIR
            
            # Create backup directory
            BACKUP_DIR="/var/www/finance-frontend/backups"
            sudo mkdir -p $BACKUP_DIR
            sudo chown -R $USER:$USER $BACKUP_DIR
            
            echo "✓ Directories created"
            
            # Remove default nginx site if it exists (prevent conflicts)
            if [ -f /etc/nginx/sites-enabled/default ]; then
              echo "Removing default Nginx site..."
              sudo rm -f /etc/nginx/sites-enabled/default
              echo "✓ Default site removed"
            fi
            # Also remove any default-* symlinks
            sudo rm -f /etc/nginx/sites-enabled/default-* 2>/dev/null || true
          SETUP_EOF

      - name: Deploy to EC2
        env:
          API_BACKEND_URL: ${{ secrets.API_BACKEND_URL || 'http://localhost:8080' }}
        run: |
          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              deploy-package.tar.gz \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              API_BACKEND_URL="$API_BACKEND_URL" 'bash -s' << 'DEPLOY_EOF'
            set -e
            FRONTEND_DIR="/var/www/finance-frontend"
            BACKUP_DIR="/var/www/finance-frontend/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Extract deployment package
            EXTRACT_DIR="/tmp/frontend-deploy-$(date +%s)"
            mkdir -p $EXTRACT_DIR
            cd $EXTRACT_DIR
            tar -xzf /tmp/deploy-package.tar.gz
            
            # Backup existing deployment if it exists
            if [ -d "$FRONTEND_DIR/build" ] || [ -f "$FRONTEND_DIR/index.html" ]; then
              echo "Backing up existing deployment..."
              sudo tar -czf $BACKUP_DIR/frontend-$TIMESTAMP.tar.gz -C $FRONTEND_DIR . 2>/dev/null || true
            fi
            
            # Remove old files
            echo "Removing old files..."
            sudo rm -rf $FRONTEND_DIR/*
            
            # Copy new files
            echo "Copying new files..."
            sudo cp -r $EXTRACT_DIR/* $FRONTEND_DIR/
            sudo chown -R www-data:www-data $FRONTEND_DIR
            sudo chmod -R 755 $FRONTEND_DIR
            
            # Configure Nginx
            echo "Configuring Nginx..."
            NGINX_CONF="/etc/nginx/sites-available/finance-frontend"
            NGINX_ENABLED="/etc/nginx/sites-enabled/finance-frontend"
            
            # Remove ALL default nginx sites FIRST to ensure they don't interfere
            echo "Removing default Nginx sites..."
            # Remove default site symlink
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            # Remove any default-* symlinks
            sudo rm -f /etc/nginx/sites-enabled/default-* 2>/dev/null || true
            # Remove any other enabled sites that might conflict (except our own)
            for site in /etc/nginx/sites-enabled/*; do
              if [ -L "$site" ] && [ "$(basename "$site")" != "finance-frontend" ]; then
                echo "Removing conflicting site: $(basename "$site")"
                sudo rm -f "$site" 2>/dev/null || true
              fi
            done
            echo "✓ Default sites removed"
            
            # Create nginx configuration with API backend URL from environment variable
            echo "Creating nginx configuration file..."
            printf '%s\n' \
              'server {' \
              '    listen 80 default_server;' \
              '    listen [::]:80 default_server;' \
              '    server_name _;' \
              '    root /var/www/finance-frontend;' \
              '    index index.html;' \
              '    gzip on;' \
              '    gzip_vary on;' \
              '    gzip_min_length 1024;' \
              '    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;' \
              '    location / {' \
              '        try_files $uri $uri/ /index.html;' \
              '        add_header Cache-Control "no-cache, no-store, must-revalidate";' \
              '    }' \
              '    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {' \
              '        expires 1y;' \
              '        add_header Cache-Control "public, immutable";' \
              '    }' \
              '    location /api {' \
              '        proxy_pass API_BACKEND_URL_PLACEHOLDER;' \
              '        proxy_http_version 1.1;' \
              '        proxy_set_header Upgrade $http_upgrade;' \
              '        proxy_set_header Connection '\''\''upgrade'\''\'';' \
              '        proxy_set_header Host $host;' \
              '        proxy_set_header X-Real-IP $remote_addr;' \
              '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
              '        proxy_set_header X-Forwarded-Proto $scheme;' \
              '        proxy_cache_bypass $http_upgrade;' \
              '    }' \
              '}' | sudo tee /tmp/nginx-frontend-temp.conf > /dev/null
            
            # Verify temp file was created
            if [ ! -f /tmp/nginx-frontend-temp.conf ]; then
              echo "❌ Failed to create temporary nginx config file!"
              exit 1
            fi
            echo "✓ Temporary config file created"
            
            # Replace the API_BACKEND_URL placeholder with the actual value
            echo "Replacing API_BACKEND_URL placeholder..."
            sed -i "s|API_BACKEND_URL_PLACEHOLDER|${API_BACKEND_URL}|g" /tmp/nginx-frontend-temp.conf
            
            # Copy to final location
            echo "Copying config to $NGINX_CONF..."
            sudo cp /tmp/nginx-frontend-temp.conf $NGINX_CONF
            
            # Verify the file was copied successfully
            if [ ! -f "$NGINX_CONF" ]; then
              echo "❌ Failed to copy nginx config to $NGINX_CONF!"
              exit 1
            fi
            
            # Set proper permissions
            sudo chmod 644 $NGINX_CONF
            echo "✓ Nginx configuration file created at $NGINX_CONF"
            
            # Verify file contents (first few lines for debugging)
            echo "Verifying config file contents..."
            head -n 5 $NGINX_CONF || true
            
            # Cleanup temp file
            rm -f /tmp/nginx-frontend-temp.conf
            
            # Enable site (remove old symlink first if it exists)
            sudo rm -f $NGINX_ENABLED
            sudo ln -sf $NGINX_CONF $NGINX_ENABLED
            echo "✓ Finance-frontend site enabled"
            
            # Verify the symlink was created correctly
            if [ -L "$NGINX_ENABLED" ] && [ -f "$NGINX_CONF" ]; then
              echo "✓ Site symlink verified: $NGINX_ENABLED -> $(readlink -f $NGINX_ENABLED)"
            else
              echo "❌ Failed to enable site! Symlink check failed."
              exit 1
            fi
            
            # List all enabled sites for debugging
            echo "Enabled Nginx sites:"
            ls -la /etc/nginx/sites-enabled/ || true
            
            # Verify config file exists before testing
            if [ ! -f "$NGINX_CONF" ]; then
              echo "❌ Nginx config file not found at $NGINX_CONF!"
              echo "Available config files:"
              ls -la /etc/nginx/sites-available/ || true
              exit 1
            fi
            
            echo "Config file exists: $NGINX_CONF"
            echo "File size: $(stat -c%s $NGINX_CONF 2>/dev/null || stat -f%z $NGINX_CONF 2>/dev/null || echo 'unknown') bytes"
            
            # Test nginx configuration
            echo "Testing Nginx configuration..."
            sudo nginx -t || {
              echo "❌ Nginx configuration test failed!"
              echo "Configuration file contents:"
              sudo cat $NGINX_CONF || true
              exit 1
            }
            
            # Reload nginx
            echo "Reloading Nginx..."
            sudo systemctl reload nginx || sudo systemctl restart nginx
            
            # Verify nginx is running
            if sudo systemctl is-active --quiet nginx; then
              echo "✓ Nginx is running successfully!"
            else
              echo "❌ Nginx failed to start!"
              sudo systemctl status nginx --no-pager -l || true
              exit 1
            fi
            
            # Cleanup
            rm -rf /tmp/deploy-package.tar.gz $EXTRACT_DIR
            
            echo "Deployment completed successfully!"
          DEPLOY_EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' << 'VERIFY_EOF'
            echo "=== Nginx Status ==="
            sudo systemctl status nginx --no-pager -l || true
            echo ""
            echo "=== Nginx Config Files (sites-available) ==="
            ls -la /etc/nginx/sites-available/ | grep finance-frontend || echo "⚠️  finance-frontend config not found in sites-available"
            echo ""
            echo "=== Enabled Nginx Sites ==="
            ls -la /etc/nginx/sites-enabled/ || true
            echo ""
            if [ -f /etc/nginx/sites-available/finance-frontend ]; then
              echo "✓ Finance-frontend config file exists in sites-available"
            else
              echo "❌ Finance-frontend config file NOT found in sites-available!"
            fi
            if [ -L /etc/nginx/sites-enabled/finance-frontend ]; then
              echo "✓ Finance-frontend site is enabled"
            else
              echo "❌ Finance-frontend site is NOT enabled!"
            fi
            echo ""
            echo "=== Nginx Configuration Test ==="
            sudo nginx -t || true
            echo ""
            echo "=== Port Check ==="
            sudo netstat -tlnp | grep ":80 " || echo "Port 80 not in use"
            echo ""
            echo "=== Frontend Files ==="
            ls -lah /var/www/finance-frontend/ | head -10 || true
            echo ""
            if sudo systemctl is-active --quiet nginx; then
              if [ -L /etc/nginx/sites-enabled/finance-frontend ]; then
                echo "✓ Nginx is running successfully!"
                echo "✓ Finance-frontend site is enabled!"
                echo "✓ Frontend should be accessible at http://${{ secrets.EC2_HOST }}"
                exit 0
              else
                echo "❌ Nginx is running but finance-frontend site is not enabled!"
                exit 1
              fi
            else
              echo "❌ Nginx is not running!"
              exit 1
            fi
          VERIFY_EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf deploy-package deploy-package.tar.gz
