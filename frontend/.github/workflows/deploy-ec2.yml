name: Deploy Frontend to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy-ec2.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  FRONTEND_DIR: /var/www/finance-frontend

jobs:
  deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || '/api' }}
        run: npm run build

      - name: Create deployment package
        run: |
          cd build
          tar -czf ../frontend-build.tar.gz .
          cd ..

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          # Copy build files to EC2
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            frontend-build.tar.gz \
            ${{ secrets.EC2_USER || 'ubuntu' }}@${{ secrets.EC2_HOST }}:/tmp/

          # SSH into EC2 and deploy
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER || 'ubuntu' }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          
          set -e
          
          echo "========================================="
          echo "Starting Frontend Deployment"
          echo "========================================="
          
          FRONTEND_DIR="/var/www/finance-frontend"
          BACKUP_DIR="$FRONTEND_DIR/backups"
          
          # Create directories if they don't exist
          sudo mkdir -p $FRONTEND_DIR
          sudo mkdir -p $BACKUP_DIR
          
          # Create backup of current deployment (if exists)
          if [ -d "$FRONTEND_DIR" ] && [ "$(ls -A $FRONTEND_DIR)" ]; then
            echo "Creating backup of current deployment..."
            BACKUP_FILE="$BACKUP_DIR/frontend-$(date +%Y%m%d_%H%M%S).tar.gz"
            cd $FRONTEND_DIR
            sudo tar -czf $BACKUP_FILE . 2>/dev/null || true
            echo "Backup created: $BACKUP_FILE"
          fi
          
          # Extract new build
          echo "Extracting new build..."
          cd $FRONTEND_DIR
          sudo rm -rf * .[^.]* 2>/dev/null || true
          sudo tar -xzf /tmp/frontend-build.tar.gz
          sudo chown -R www-data:www-data $FRONTEND_DIR
          sudo chmod -R 755 $FRONTEND_DIR
          
          # Cleanup
          rm -f /tmp/frontend-build.tar.gz
          
          echo "Build files deployed successfully!"
          
          ENDSSH

      - name: Setup Nginx on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER || 'ubuntu' }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          
          set -e
          
          echo "========================================="
          echo "Setting up Nginx"
          echo "========================================="
          
          # Install Nginx if not installed
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            sudo apt-get update -qq
            sudo apt-get install -y nginx
            echo "Nginx installed successfully"
          else
            echo "Nginx is already installed"
            nginx -v
          fi
          
          # Create Nginx configuration
          NGINX_CONF="/etc/nginx/sites-available/finance-frontend"
          
          echo "Creating Nginx configuration..."
          sudo tee $NGINX_CONF > /dev/null << 'NGINX_CONFIG'
          server {
              listen 80;
              server_name _;
              root /var/www/finance-frontend;
              index index.html;
              
              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
              
              # Serve static files
              location / {
                  try_files $uri $uri/ /index.html;
                  add_header Cache-Control "no-cache, no-store, must-revalidate";
              }
              
              # Cache static assets
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              # Proxy API requests to backend
              location /api {
                  proxy_pass http://localhost:8080;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
          }
          NGINX_CONFIG
          
          # Enable site
          sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/finance-frontend
          
          # Remove default nginx site if it exists
          if [ -f /etc/nginx/sites-enabled/default ]; then
            sudo rm /etc/nginx/sites-enabled/default
            echo "Removed default Nginx site"
          fi
          
          # Test Nginx configuration
          echo "Testing Nginx configuration..."
          sudo nginx -t
          
          # Reload Nginx
          echo "Reloading Nginx..."
          sudo systemctl reload nginx || sudo systemctl restart nginx
          
          # Verify Nginx is running
          if sudo systemctl is-active --quiet nginx; then
            echo "✓ Nginx is running successfully!"
          else
            echo "❌ Nginx failed to start!"
            sudo systemctl status nginx --no-pager -l || true
            exit 1
          fi
          
          echo "========================================="
          echo "Nginx setup completed successfully!"
          echo "========================================="
          
          ENDSSH

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER || 'ubuntu' }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          
          echo "========================================="
          echo "Verifying Deployment"
          echo "========================================="
          
          # Check if files exist
          if [ -f "/var/www/finance-frontend/index.html" ]; then
            echo "✓ Frontend files deployed successfully"
          else
            echo "❌ Frontend files not found!"
            exit 1
          fi
          
          # Check Nginx status
          if sudo systemctl is-active --quiet nginx; then
            echo "✓ Nginx is running"
          else
            echo "❌ Nginx is not running!"
            exit 1
          fi
          
          # Check if Nginx is serving the site
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✓ Frontend is accessible via Nginx (HTTP $HTTP_CODE)"
          else
            echo "⚠ Frontend returned HTTP $HTTP_CODE (may need to check configuration)"
          fi
          
          echo ""
          echo "Deployment URL: http://${{ secrets.EC2_HOST }}"
          echo "========================================="
          
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f frontend-build.tar.gz

